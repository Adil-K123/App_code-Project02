---

- hosts: "{{ Monitoring_Servers }}"
  become: true
  tasks:
   - name: update and upgrade
     tags: always
     apt:
      upgrade: dist
      update_cache: yes

   - name: Install Docker
     shell: |
          sudo apt-get -y update
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get -y update
          sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
   
   - name: copy prometheus yml file
     copy:
        src: ../prometheus/prometheus.yml
        dest: /home/ubuntu/prometheus.yml
    
   - name: create grafana db directory
     file:
        path: /home/ubuntu/grafana_db
        state: directory
        mode: '777'
   
   - name: Copy docker compose
     copy:
        src: ../monitoring_docker_compose.yml 
        dest: /home/ubuntu/monitoring.yml

   - name: Docker compose up
     shell: |
        sudo docker compose -f monitoring.yml up -d
