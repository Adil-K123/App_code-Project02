---

- hosts: all
  become: true
  pre_tasks:
    - name: Update and upgrade packages
      apt:
        upgrade: yes
        update_cache: yes
        cache_valid_time: 86400   #one day
  
  tasks:
    - name: install tools to install docker
      tags: docker,curl,ca-certificates
      apt:
        name:
           - curl
           - ca-certificates
           - unzip 
        state: latest
        update_cache: yes

    - name: Gather package facts
      package_facts:
        manager: apt

    - name: Install Docker
      tags: docker
      shell: |
          sudo apt-get -y update
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get -y update
          sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      when: >
         "docker-ce" not in ansible_facts.packages or
         "docker-ce-cli" not in ansible_facts.packages or
         "containerd.io" not in ansible_facts.packages or
         "docker-buildx-plugin" not in ansible_facts.packages or
         "docker-compose-plugin" not in ansible_facts.packages

          
- hosts: "{{ env_webserver1 }}"
  become: true
  tasks:
    - name: Install mysql-client to configure db
      tags: mysql-client
      apt:
        name:
          - mysql-client
        state: latest
        update_cache: yes

    - name: create rds sql database and required table from first webserver
      tags: sql,db,rds
      command: |
         mysql -h{{ rds_endpoint }} -u{{ dbusername }} -p{{ dbpassword }} -e "CREATE DATABASE IF NOT EXISTS product_reviews; USE product_reviews; CREATE TABLE IF NOT EXISTS reviews (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255), product_name VARCHAR(255), review TEXT);"

    - name: Check if Swarm is already initialized
      shell: docker info --format '{{ "{{ .Swarm.LocalNodeState }}" }}'
      register: swarm_status
      changed_when: false
      
    - name: Initialize the Docker Swarm if not already initialized
      command: docker swarm init
      when: swarm_status.stdout == "inactive"

    - name: Get Join Token for Workers
      shell: docker swarm join-token -q worker
      register: worker_join_token

    - name: Set fact for worker join token
      set_fact:
        worker_token: "{{ worker_join_token.stdout }}"

    - name: Print workertoken for env_webserver1
      debug:
        var: worker_token

- hosts: "{{ env_webserver_group }}"
  become: true
  vars:
    env_webserver1: "{{ lookup('vars', 'env_webserver1') | default('') }}"

  tasks:
    - name: Create environment file
      tags: environment,db
      copy:
         dest: /etc/productreview_app.env
         content: |
           MYSQL_HOST={{ rds_endpoint }}
           MYSQL_USER={{ dbusername }}
           MYSQL_PASSWORD={{ dbpassword }}
           MYSQL_DATABASE=product_reviews

    - name: ensures nginx conf dir exists
      file: 
         path: /home/ubuntu/nginx
         state: directory

    - name: Copy file
      copy:
         src: ../nginx/default.conf
         dest: /home/ubuntu/nginx/default.conf

    - name: Check if AWS CLI is installed
      command: which aws
      register: aws_cli_check
      ignore_errors: yes

    - name: Download aws cli zip file
      shell: |
        curl -o /tmp/awscliv2.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
      args:
        executable: /bin/bash
      when: aws_cli_check.rc != 0
      
    - name: Unzip aws cli
      shell: |
          if [ ! -d "/tmp/aws" ]; then
            unzip /tmp/awscliv2.zip -d /tmp/
          fi
      args:
        executable: /bin/bash
      when: aws_cli_check.rc != 0
      
    - name: Install aws cli
      shell: |
        if [ -d "/usr/local/aws-cli/v2/current" ]; then
          /tmp/aws/install --update
        else
          /tmp/aws/install
        fi
      args:
        executable: /bin/bash
      when: aws_cli_check.rc != 0

    - name: Aws ecr login
      tags: aws,ecr
      shell: |
        aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin {{ aws_account_id }}.dkr.ecr.us-east-1.amazonaws.com

    - name: Join the Swarm as Worker if not already joined
      command: docker swarm join --token {{ hostvars[env_webserver1]['worker_token'] }} {{ hostvars[env_webserver1]['ansible_facts'][default_ipv4.address'] }}:2377
      when: inventory_hostname not in groups[env_webserver1]

- hosts: "{{ monitoring_server_group }}"
  become: true
  tasks:
    - name: create grafana_db directory
      file:
        path: /home/ubuntu/monitoring_files/grafana_db
        state: directory
        mode: '777'

    - name: create prometheus directory
      file:
        path: /home/ubuntu/monitoring_files/prometheus
        state: directory
        mode: '777'

    - name: copy prometheus yml file
      copy:
        src: ../monitoring_files/prometheus/prometheus.yml
        dest: /home/ubuntu/monitoring_files/prometheus/prometheus.yml
   
    - name: Copy docker compose
      copy:
        src: ../monitoring_files/monitoring_docker_compose.yml 
        dest: /home/ubuntu/monitoring_files/monitoring_docker_compose.yml
  
    - name: Docker compose up
      shell: |
        cd /home/ubuntu/monitoring_files
        sudo docker compose -f monitoring_docker_compose.yml up -d
 
    

    